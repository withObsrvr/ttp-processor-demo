openapi: 3.0.0
info:
  title: TTP Processor API
  description: |
    Enterprise-grade service for processing and transforming Stellar ledger data.
    Provides reliable, scalable data processing with enterprise features:
    - Circuit breaker pattern for fault tolerance
    - Comprehensive metrics and monitoring
    - Structured logging
    - Health checks
    - Enterprise-grade error handling

    ## gRPC Service
    The primary interface for this service is gRPC, defined in the protocol buffers file.
    The service provides a streaming interface for processing ledger data.

    ### Service Definition
    ```protobuf
    service TTPProcessor {
      // Processes raw ledger data and returns transformed data
      rpc ProcessLedgers(ProcessLedgersRequest) returns (stream ProcessedLedger) {}
    }
    ```

    ### Message Types
    ```protobuf
    message ProcessLedgersRequest {
      uint32 start_ledger = 1;
      optional uint32 end_ledger = 2;
      repeated string transformations = 3; // List of transformations to apply
    }

    message ProcessedLedger {
      uint32 sequence = 1;
      bytes transformed_data = 2; // Transformed ledger data in specified format
      map<string, string> metadata = 3; // Additional metadata about the transformation
    }
    ```

    ### Error Codes
    | Code | Description |
    |------|-------------|
    | 0    | OK - Success |
    | 1    | CANCELLED - Operation cancelled |
    | 2    | UNKNOWN - Unknown error |
    | 3    | INVALID_ARGUMENT - Invalid request parameters |
    | 4    | DEADLINE_EXCEEDED - Operation timed out |
    | 5    | NOT_FOUND - Resource not found |
    | 6    | ALREADY_EXISTS - Resource already exists |
    | 7    | PERMISSION_DENIED - Permission denied |
    | 8    | RESOURCE_EXHAUSTED - Resource exhausted |
    | 9    | FAILED_PRECONDITION - Operation failed precondition |
    | 10   | ABORTED - Operation aborted |
    | 11   | OUT_OF_RANGE - Value out of range |
    | 12   | UNIMPLEMENTED - Operation not implemented |
    | 13   | INTERNAL - Internal error |
    | 14   | UNAVAILABLE - Service unavailable |
    | 15   | DATA_LOSS - Data loss |
    | 16   | UNAUTHENTICATED - Authentication failed |
  version: 1.0.0
  contact:
    name: Obsrvr Team
    email: support@obsrvr.com
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0.html

servers:
  - url: http://localhost:50053
    description: Local development server
  - url: https://api.obsrvr.com/ttp-processor
    description: Production server

tags:
  - name: TTPProcessor
    description: Ledger data processing service
  - name: Health
    description: Health check and monitoring endpoints

paths:
  /health:
    get:
      tags:
        - Health
      summary: Health check endpoint
      description: Returns the current health status and metrics of the service
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [healthy, degraded, unhealthy]
                    description: Current health status
                  metrics:
                    type: object
                    properties:
                      retry_count:
                        type: integer
                        description: Number of retries performed
                      error_count:
                        type: integer
                        description: Number of errors encountered
                      success_count:
                        type: integer
                        description: Number of successful operations
                      total_latency:
                        type: string
                        description: Total processing latency
                      average_latency:
                        type: string
                        description: Average processing latency
                      last_error:
                        type: string
                        description: Last error encountered
                      last_error_time:
                        type: string
                        format: date-time
                        description: Timestamp of last error
                      circuit_breaker_state:
                        type: string
                        enum: [closed, open, half-open]
                        description: Current circuit breaker state
                      uptime_percent:
                        type: number
                        format: float
                        description: Service uptime percentage
                      total_processed:
                        type: integer
                        description: Total ledgers processed
                      total_bytes:
                        type: integer
                        description: Total bytes processed
                      last_sequence:
                        type: integer
                        description: Last processed ledger sequence
                      error_types:
                        type: object
                        description: Error type distribution
                      transformation_stats:
                        type: object
                        description: Statistics for each transformation type
                  guarantees:
                    type: object
                    properties:
                      min_uptime:
                        type: number
                        format: float
                        description: Minimum uptime guarantee
                      max_latency_p99:
                        type: string
                        description: Maximum P99 latency guarantee
                      max_retry_latency:
                        type: string
                        description: Maximum retry latency guarantee
        '503':
          description: Service is unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  schemas:
    Error:
      type: object
      properties:
        code:
          type: integer
          description: Error code
        message:
          type: string
          description: Error message
        details:
          type: array
          items:
            type: object
            description: Additional error details

    ProcessedLedger:
      type: object
      properties:
        sequence:
          type: integer
          format: uint32
          description: Ledger sequence number
        transformed_data:
          type: string
          format: byte
          description: Transformed ledger data
        metadata:
          type: object
          additionalProperties:
            type: string
          description: Additional metadata about the transformation

    ProcessLedgersRequest:
      type: object
      properties:
        start_ledger:
          type: integer
          format: uint32
          description: Starting ledger sequence number
        end_ledger:
          type: integer
          format: uint32
          description: Optional ending ledger sequence number
          nullable: true
        transformations:
          type: array
          items:
            type: string
          description: List of transformations to apply

security:
  - ApiKeyAuth: []
  - BearerAuth: []

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT 